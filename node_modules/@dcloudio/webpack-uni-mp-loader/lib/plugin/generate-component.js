const path = require('path')
const {
  normalizePath
} = require('@dcloudio/uni-cli-shared')
const {
  getComponentSet
} = require('@dcloudio/uni-cli-shared/lib/cache')

const uniPath = normalizePath(require.resolve('@dcloudio/uni-' + process.env.UNI_PLATFORM))
// TODO 解决方案不太理想
module.exports = function generateComponent (compilation) {
  const components = getComponentSet()
  if (components.size) {
    const assets = compilation.assets
    const modules = compilation.modules

    const uniModuleId = modules.find(module => module.resource && normalizePath(module.resource) === uniPath).id

    Object.keys(assets).forEach(name => {
      if (components.has(name.replace('.js', ''))) {
        const chunkName = name.replace('.js', '-create-component')

        let moduleId = ''
        if (name.indexOf('node-modules') === 0) {
          const resource = normalizePath(
            path.resolve(
              process.env.UNI_INPUT_DIR,
              '../node_modules',
              name.replace('node-modules/', '').replace('.js', '.vue')
            )
          )
          const altResource = normalizePath(
            path.resolve(
              process.env.UNI_INPUT_DIR,
              name.replace('node-modules', 'node_modules').replace('.js', '.vue')
            )
          )
          moduleId = modules.find(
            module => {
              if (module.resource) {
                const moduleResource = normalizePath(module.resource)
                return moduleResource === resource || moduleResource === altResource
              }
            }).id
        } else {
          const resource = normalizePath(
            path.resolve(process.env.UNI_INPUT_DIR, name.replace('.js', '.vue'))
          )
          moduleId = modules.find(
            module => module.resource && normalizePath(module.resource) === resource).id
        }
        const source = assets[name].source() +
                    `
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    '${chunkName}',
    {
        '${chunkName}':(function(module, exports, __webpack_require__){
            __webpack_require__('${uniModuleId}')['createComponent'](__webpack_require__(${JSON.stringify(moduleId)}))
        })
    },
    [['${chunkName}']]
]);                
`
        assets[name] = {
          size () {
            return Buffer.byteLength(source, 'utf8')
          },
          source () {
            return source
          }
        }
      }
    })
  }
}
